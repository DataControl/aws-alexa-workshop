---
title: "2. Smart Lamp Simulator"
date: 2019-09-05T23:06:51+08:00
draft: false
chapter: false
weight: 202
---

In this step you'll learn how to connect a virtual Smart Lamp to AWS IoT Core in order to be able to control it remotely.
The programming model used in this simulated device is similar to what you would embed in the real thing, albeit you might use [Amazon FreeRTOS](https://aws.amazon.com/freertos/) and not NodeJS.

## Create a Thing on AWS IoT Console
For the device to be able to communicate with AWS IoT, we need to setup few things first. AWS IoT Core uses X.509 certificates to perform mutual TLS authentication and be able to identify the devices trying to connect. Once authenticated, AWS IoT Core checks the IoT Policy associated with the Certificate in order to know what the device is allowed to perform. Finally, you would typically want to keep additional metadata for your device in order to easily identify it when you need to interact with it: for this reason you'll also create a Thing in the AWS IoT Core Registry.

Let’s setup Thing, Certificates and AWS IoT Policies.

1. Log in the [AWS IoT console](https://console.aws.amazon.com/iot/home?region=us-east-1#/connIntro) and make sure you are in the region communicated at the beginning of the workshop. It should like 
the following. The console provides a simplified flow to create a Thing which we will use
![](/images/smart-home/simulator/simulator-1.png)

1. Click **Get Started** under **Configuring a device**; and click **Get started** again on the next screen

1. If you are using AWS Cloud9, select **Linux** as the platform; choose **Node.js** for IoT 
Device SDK. This is used to generate a full package for us to quickly connect to AWS IoT. 
Choose **Next** to continue
![](/images/smart-home/simulator/simulator-3.png)

1. Enter `smart-lamp-0001` for the **Name** field, and click **Next step** 
![](/images/smart-home/simulator/simulator-5.png)

1. Everything has been generated for you! Click the button under **Download connection kit for** to download the package.
![](/images/smart-home/simulator/simulator-6.png)

1. You can ignore the next screens

To summary, the following contents have been created:
* A certificate to identify the device
* A Thing in the registry to represent the device and its additional attributed, to which the certificate is attached
* A security **policy** allow device to send and receive messages, which is attached to the certificate
* A zip file containing the public device certificate, the private key and a sample Hello World script you can use to test the setup
![](/images/smart-home/simulator/simulator-8.png)

{{% notice warning %}}
Do NOT lose this zip file, it contains your private key file which cannot be retrieved again.
Do NOT need to run the scripts on the last page of the wizard, just click **Done** and **Done** again. 
{{% /notice %}}

{{% notice info %}}
In real circumstances, the private key should never leave the device and you should use a secure element to generate it. In such case the "registration" process would look a bit different. The device would already be provisioned with a certificate that has been generated during the manufacturing process, and the registration would take place [JIT](https://docs.aws.amazon.com/iot/latest/developerguide/jit-provisioning.html). 
{{% /notice %}}

## Modify Default Policy
The default security policy created by the above wizard will limit the 
topics your device can publish on. For the labs in this workshop we’re going 
to create a more open policy, to avoid trouble with misspelling or configurations, but please keep in mind that the **least priviledge** principle should always be applied. Check the [documentation](https://docs.aws.amazon.com/iot/latest/developerguide/authorization.html) on how to write secure policies.

1. If you do not see the thing you just created, click on **Manage** - it will default to **Things**

1. Find the thing you just created, for example **smart-lamp-0001** for this lab

1. Click on your device to see it’s details

1. Click on **Security**

1. Click on the attached certificate - see below
![](/images/smart-home/simulator/simulator-15.png)

1. Click on **Policies**
![](/images/smart-home/simulator/simulator-16.png)

1. Click on your policy, in this lab it is named **ratchet-Policy**

1. Click **Edit Policy Document**

1. Enter the following for your document
    ```
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "iot:Publish",
            "iot:Subscribe",
            "iot:Connect",
            "iot:Receive"
          ],
          "Resource": [
            "*"
          ]
        }
      ]
    }
    ```

1. Click **Save as new version**
![](/images/smart-home/simulator/simulator-17.png)

Your device can now publish and subscribe to any topics. So far, three required 
components to use AWS IoT have been created:

* Device certificates
* A security policy and being modified for the permission we need
* The certificate and security policy have been attached to the thing **smart-lamp-0001**

{{% notice info %}}
You might wonder which permission is `iot:Receive`. When a device connects, in order to receive messages from the AWS IoT Core broker,
it has to subscribe to the topics of interest, and the AWS IoT Device Gateway will ensure that the `iot:Subscribe` policy allows it. 
Once the device is connected the `iot:Subscribe` policy is not re-evaluated, which means that to remove the possibility for a device
to receive messages, for example when a device is compromised and you need to quarantine the device, it can be done by denying `iot:Receive`. 
{{% /notice %}}

## Subscribe to IoT Core

{{% notice info %}}
You will need to Cloud9 environment for this lab. Access it [here](https://console.aws.amazon.com/cloud9/home?region=us-east-1#/). Make sure you have finished 
<a href="/20-getting-started/create-cloud9-env/" target="_blank">Create a Cloud9 Environment</a>. This link will 
open a new tab, please do remember to return to current page.
{{% /notice %}}

{{% notice note %}}
If you are using your own laptop, please verify weather your network cannot access external 8883 port. Consider using a personal hotspot if it doesn't work. 
{{% /notice %}}

1. Git clone [this repo]({{% siteparam simulatorRepo %}}), type the following code in Cloud9
terminal
    ```
    git clone {{% siteparam simulatorRepo %}} --depth=1 alexa-iot-workshop-lamp
    cd alexa-iot-workshop-lamp
    ```

1. **Extract** the zip file you downloaded above. You will get the following things.
   - A **private key** named `<thing-name>.private.key`
   - A **device certificate** named `<thing-name>.cert.pem`
   - Some other stuff...

1. Rename the private key to **private.key** and drag and upload to **credentials** folder. 

1. Rename the device certificate to **cert.pem** and drag and upload to **credentials** folder

1. Open the `config.js` file, update the following configurations, and save
    - `iotEndpoint`. You could find it in Iot console - settings
    ![](/images/smart-home/simulator/simulator-18.png?width=500)
    - `thingName`. The name of created thing, likely `smart-lamp-0001`
    - `deviceBindingUrl`. It is the url where you deployed in the [Device Binding UI]({{< ref "1.build-device-ui.md" >}}).
      If you followed the guide, please go to AWS Amplify Console to find it, which named **Production branch URL**
    ![](/images/smart-home/amplify-url.png?width=500)

1. Install dependencies. Run `npm install` in Cloud9 terminal 

1. Run `node index.js` to start the application. 

The program listens to shadow information and send reported status to AWS IoT core. In real life, you would make sure that 
the device's status has actually  been changed before you send reported status. Here, since we don't have hardware in this 
session, we simply report back as soon as we receive the delta.  

The virtual lamp outputs a QRCode in the terminal and an URL with the same link that will be used to claim the device.

![](/images/smart-home/simulator/qrcode-terminal.png?width=400)

## Test Shadow 

In the step, we demo the on & off status of the device by maually sending changes to the topic below.

1. Open the AWS IoT Console and select **Test**

1. In the Subscribe field enter `$aws/things/+/shadow/#` (`+` is a single level topic wildcard, `#` is a multilevel wildcard and can only appear at the end). Press **Subscribe to topic**

1. In the publish topic field enter `$aws/things/smart-lamp-0001/shadow/update`

1. In the message field enter the following text and press **Publish**

```json
{
      "state": {
          "desired": {
          "powerState": "ON"
          }
      }
}
```

You should see the following outputs in the device simulator terminal:
```
turn ON Smart Lamp
```

For more information upon shadow, please check [using shadows](https://docs.aws.amazon.com/iot/latest/developerguide/using-device-shadows.html)


